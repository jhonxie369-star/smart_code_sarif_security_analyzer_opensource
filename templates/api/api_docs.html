<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API接口文档 - 智能代码安全分析平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 0; }
        .api-section { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .method-badge { font-size: 0.8em; padding: 4px 8px; border-radius: 4px; margin-right: 8px; }
        .method-get { background: #28a745; color: white; }
        .method-post { background: #dc3545; color: white; }
        .method-put { background: #fd7e14; color: white; }
        .method-delete { background: #6c757d; color: white; }
        .endpoint-url { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 8px 12px; border-radius: 4px; border-left: 4px solid #007bff; }
        .param-table { font-size: 0.9em; }
        .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; }
        .nav-pills .nav-link.active { background-color: #667eea; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-book"></i> API接口文档</h1>
                    <p class="lead mb-0">完整的REST API接口说明，支持第三方系统集成</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> 返回主页</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- 侧边导航 -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list"></i> API导航</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-pills flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#auth">认证授权</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#findings">漏洞管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#projects">项目管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#scans">扫描任务</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#statistics">统计分析</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#system">系统管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="col-md-9">
                <!-- 认证授权 -->
                <section id="auth" class="api-section">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-shield-lock"></i> 认证授权</h4>
                    </div>
                    <div class="card-body">
                        <p>平台支持Session认证和Token认证两种方式。</p>
                        
                        <div class="mb-4">
                            <h6>Session认证（推荐）</h6>
                            <div class="code-block">
# 登录获取Session
curl -X POST http://your-domain/admin/login/ \
  -d "username=admin&password=your_password" \
  -c cookies.txt

# 使用Session访问API
curl -X GET http://your-domain/api/v1/findings/ \
  -b cookies.txt
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Token认证</h6>
                            <div class="code-block">
# 获取Token（需要先在管理后台创建）
curl -X GET http://your-domain/api/v1/auth/token/ \
  -H "Authorization: Basic base64(username:password)"

# 使用Token访问API
curl -X GET http://your-domain/api/v1/findings/ \
  -H "Authorization: Token your_token_here"
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 漏洞管理 -->
                <section id="findings" class="api-section">
                    <div class="card-header bg-danger text-white">
                        <h4><i class="bi bi-bug"></i> 漏洞管理 API</h4>
                    </div>
                    <div class="card-body">
                        <!-- 获取漏洞列表 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">获取漏洞列表</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/findings/</div>
                            
                            <h6>查询参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>说明</th><th>示例</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>severity</td><td>string</td><td>严重程度过滤</td><td>高危/中危/低危</td></tr>
                                    <tr><td>active</td><td>boolean</td><td>活跃状态过滤</td><td>true/false</td></tr>
                                    <tr><td>project</td><td>int</td><td>项目ID过滤</td><td>1</td></tr>
                                    <tr><td>cwe_id</td><td>string</td><td>CWE编号过滤</td><td>CWE-79</td></tr>
                                    <tr><td>search</td><td>string</td><td>搜索关键词</td><td>XSS</td></tr>
                                    <tr><td>page</td><td>int</td><td>页码</td><td>1</td></tr>
                                    <tr><td>page_size</td><td>int</td><td>每页数量</td><td>20</td></tr>
                                </tbody>
                            </table>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "count": 150,
  "next": "http://your-domain/api/v1/findings/?page=2",
  "previous": null,
  "results": [
    {
      "id": 1,
      "title": "Cross-site Scripting (XSS)",
      "severity": "高危",
      "cwe_id": "CWE-79",
      "file_path": "/src/main.js",
      "line_number": 42,
      "description": "用户输入未经过滤直接输出到页面",
      "project": {
        "id": 1,
        "name": "Web应用项目",
        "department": "技术部"
      },
      "created": "2025-01-23T10:30:00Z",
      "updated": "2025-01-23T10:30:00Z",
      "active": true,
      "false_positive": false,
      "risk_accepted": false,
      "ai_analysis": {
        "analyzed": true,
        "risk_assessment": "高风险XSS漏洞...",
        "fix_suggestion": "使用HTML转义函数...",
        "prevention_advice": "实施输入验证..."
      }
    }
  ]
}
                            </div>
                        </div>

                        <!-- AI分析 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">AI智能分析</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/findings/{id}/ai_analyze/</div>
                            
                            <h6>请求示例</h6>
                            <div class="code-block">
curl -X POST http://your-domain/api/v1/findings/1/ai_analyze/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Token your_token" \
  -d '{
    "force_reanalyze": false
  }'
                            </div>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "success": true,
  "message": "AI分析完成",
  "analysis": {
    "risk_assessment": "这是一个高风险的XSS漏洞...",
    "fix_suggestion": "建议使用以下方法修复...",
    "prevention_advice": "为防止类似漏洞..."
  }
}
                            </div>
                        </div>

                        <!-- 批量AI分析 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">批量AI分析</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/findings/batch_ai_analyze/</div>
                            
                            <h6>请求参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>必填</th><th>说明</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>finding_ids</td><td>array</td><td>是</td><td>漏洞ID列表</td></tr>
                                    <tr><td>rule_id</td><td>string</td><td>否</td><td>按CWE规则批量分析</td></tr>
                                    <tr><td>force_reanalyze</td><td>boolean</td><td>否</td><td>强制重新分析</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 更新漏洞状态 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-put">PUT</span>
                                <h6 class="mb-0">更新漏洞状态</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/findings/{id}/</div>
                            
                            <h6>请求示例</h6>
                            <div class="code-block">
{
  "active": false,
  "false_positive": true,
  "notes": "经确认为误报"
}
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 项目管理 -->
                <section id="projects" class="api-section">
                    <div class="card-header bg-success text-white">
                        <h4><i class="bi bi-folder"></i> 项目管理 API</h4>
                    </div>
                    <div class="card-body">
                        <!-- 获取项目列表 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">获取项目列表</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/projects/</div>
                            
                            <h6>查询参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>说明</th><th>示例</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>department</td><td>int</td><td>部门ID过滤</td><td>1</td></tr>
                                    <tr><td>business_criticality</td><td>string</td><td>业务重要性</td><td>high/medium/low</td></tr>
                                    <tr><td>is_active</td><td>boolean</td><td>活跃状态</td><td>true/false</td></tr>
                                    <tr><td>auto_scan_enabled</td><td>boolean</td><td>自动扫描状态</td><td>true/false</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 创建项目 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">创建项目</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/projects/</div>
                            
                            <h6>请求示例</h6>
                            <div class="code-block">
{
  "name": "新项目",
  "description": "项目描述",
  "department": 1,
  "business_criticality": "high",
  "git_url": "https://github.com/user/repo.git",
  "git_branch": "main",
  "auto_scan_enabled": true,
  "responsible_person": "张三"
}
                            </div>
                        </div>

                        <!-- 项目统计 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">项目统计信息</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/projects/{id}/statistics/</div>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "project_id": 1,
  "project_name": "Web应用项目",
  "total_findings": 45,
  "severity_stats": {
    "高危": 5,
    "中危": 15,
    "低危": 25
  },
  "cwe_stats": {
    "CWE-79": 8,
    "CWE-89": 3,
    "CWE-22": 2
  },
  "trend_data": [
    {"date": "2025-01-20", "count": 40},
    {"date": "2025-01-21", "count": 42},
    {"date": "2025-01-22", "count": 45}
  ]
}
                            </div>
                        </div>

                        <!-- 自动扫描 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">启动自动扫描</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/projects/{id}/auto_scan/</div>
                            
                            <h6>请求参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>必填</th><th>说明</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>scan_type</td><td>string</td><td>否</td><td>扫描类型(codeql/semgrep/auto)</td></tr>
                                    <tr><td>branch</td><td>string</td><td>否</td><td>指定分支(默认使用项目配置)</td></tr>
                                    <tr><td>force_rescan</td><td>boolean</td><td>否</td><td>强制重新扫描</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 扫描任务 -->
                <section id="scans" class="api-section">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="bi bi-search"></i> 扫描任务 API</h4>
                    </div>
                    <div class="card-body">
                        <!-- 获取扫描任务 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">获取扫描任务列表</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/scans/</div>
                            
                            <h6>查询参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>说明</th><th>示例</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>project</td><td>int</td><td>项目ID过滤</td><td>1</td></tr>
                                    <tr><td>tool_name</td><td>string</td><td>扫描工具</td><td>codeql/semgrep</td></tr>
                                    <tr><td>status</td><td>string</td><td>任务状态</td><td>pending/running/completed/failed</td></tr>
                                    <tr><td>date_from</td><td>date</td><td>开始日期</td><td>2025-01-20</td></tr>
                                    <tr><td>date_to</td><td>date</td><td>结束日期</td><td>2025-01-23</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 快速扫描 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">Git快速扫描</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/quick-scan/</div>
                            
                            <h6>请求示例</h6>
                            <div class="code-block">
{
  "git_url": "https://github.com/user/repo.git",
  "branch": "main",
  "project_name": "测试项目",
  "department": "技术部",
  "scan_type": "auto"
}
                            </div>
                        </div>

                        <!-- 解析报告 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">解析SARIF报告</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/scans/{id}/parse_report/</div>
                            
                            <h6>请求参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>必填</th><th>说明</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>report_file</td><td>file</td><td>是</td><td>SARIF报告文件</td></tr>
                                    <tr><td>auto_ai_analyze</td><td>boolean</td><td>否</td><td>自动AI分析</td></tr>
                                    <tr><td>merge_duplicates</td><td>boolean</td><td>否</td><td>合并重复漏洞</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 获取扫描日志 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">获取扫描日志</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/scans/{id}/logs/</div>
                            
                            <h6>查询参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>说明</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>last_line</td><td>int</td><td>获取指定行之后的日志</td></tr>
                                    <tr><td>level</td><td>string</td><td>日志级别过滤</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 终止扫描任务 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-post">POST</span>
                                <h6 class="mb-0">终止扫描任务</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/scans/{id}/kill_task/</div>
                        </div>
                    </div>
                </section>

                <!-- 统计分析 -->
                <section id="statistics" class="api-section">
                    <div class="card-header bg-info text-white">
                        <h4><i class="bi bi-graph-up"></i> 统计分析 API</h4>
                    </div>
                    <div class="card-body">
                        <!-- 全局统计 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">全局统计概览</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/statistics/overview/</div>
                            
                            <h6>查询参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>说明</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>department</td><td>string</td><td>部门过滤</td></tr>
                                    <tr><td>date_from</td><td>date</td><td>统计开始日期</td></tr>
                                    <tr><td>date_to</td><td>date</td><td>统计结束日期</td></tr>
                                </tbody>
                            </table>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "total_findings": 1250,
  "severity_distribution": {
    "高危": 125,
    "中危": 450,
    "低危": 675
  },
  "department_stats": [
    {
      "department": "技术部",
      "total": 800,
      "high": 80,
      "medium": 300,
      "low": 420
    }
  ],
  "trend_data": [
    {"date": "2025-01-20", "total": 1200, "high": 120},
    {"date": "2025-01-21", "total": 1225, "high": 122}
  ],
  "top_cwe": [
    {"cwe": "CWE-79", "count": 85, "name": "Cross-site Scripting"},
    {"cwe": "CWE-89", "count": 42, "name": "SQL Injection"}
  ]
}
                            </div>
                        </div>

                        <!-- AI分析统计 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">AI分析统计</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/statistics/ai_stats/</div>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "total_analyzed": 450,
  "analysis_rate": 0.36,
  "avg_analysis_time": 2.5,
  "success_rate": 0.95,
  "monthly_usage": [
    {"month": "2025-01", "count": 450}
  ]
}
                            </div>
                        </div>

                        <!-- 队列状态 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">扫描队列状态</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/v1/statistics/queue_status/</div>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "queue_length": 3,
  "running_tasks": 1,
  "completed_today": 15,
  "failed_today": 2,
  "avg_wait_time": 120
}
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 系统管理 -->
                <section id="system" class="api-section">
                    <div class="card-header bg-secondary text-white">
                        <h4><i class="bi bi-gear"></i> 系统管理 API</h4>
                    </div>
                    <div class="card-body">
                        <!-- 系统日志 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">获取系统日志</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/system-logs/</div>
                            
                            <h6>查询参数</h6>
                            <table class="table table-sm param-table">
                                <thead>
                                    <tr><th>参数</th><th>类型</th><th>说明</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>level</td><td>string</td><td>日志级别(ERROR/WARNING/INFO/DEBUG)</td></tr>
                                    <tr><td>lines</td><td>int</td><td>返回行数(默认100)</td></tr>
                                    <tr><td>search</td><td>string</td><td>搜索关键词</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 清空日志 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-delete">DELETE</span>
                                <h6 class="mb-0">清空系统日志</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/system-logs/</div>
                        </div>

                        <!-- CWE信息查询 -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="method-badge method-get">GET</span>
                                <h6 class="mb-0">CWE信息查询</h6>
                            </div>
                            <div class="endpoint-url mb-3">/api/cwe/{cwe_number}/</div>
                            
                            <h6>响应示例</h6>
                            <div class="code-block">
{
  "success": true,
  "cwe_info": {
    "id": "CWE-79",
    "name": "Cross-site Scripting",
    "description": "软件不能正确地中和或错误地中和用户可控制的输入...",
    "category": "注入类漏洞",
    "severity_score": 8.5,
    "owasp_category": "A03:2021 – Injection"
  }
}
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 错误码说明 -->
                <section class="api-section">
                    <div class="card-header bg-dark text-white">
                        <h4><i class="bi bi-exclamation-triangle"></i> 错误码说明</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr><th>状态码</th><th>说明</th><th>示例</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>200</td><td>请求成功</td><td>正常返回数据</td></tr>
                                <tr><td>201</td><td>创建成功</td><td>创建项目/漏洞成功</td></tr>
                                <tr><td>400</td><td>请求参数错误</td><td>缺少必填参数</td></tr>
                                <tr><td>401</td><td>未授权</td><td>需要登录或Token无效</td></tr>
                                <tr><td>403</td><td>权限不足</td><td>无权限访问该资源</td></tr>
                                <tr><td>404</td><td>资源不存在</td><td>项目/漏洞不存在</td></tr>
                                <tr><td>429</td><td>请求过于频繁</td><td>触发限流</td></tr>
                                <tr><td>500</td><td>服务器内部错误</td><td>系统异常</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 平滑滚动到锚点
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // 更新导航状态
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    this.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>