<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扫描任务监控</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="/static/js/navigation.js"></script>
    <style>
        .task-card { margin-bottom: 15px; }
        .status-running { border-left: 4px solid #007bff; }
        .status-completed { border-left: 4px solid #28a745; }
        .status-failed { border-left: 4px solid #dc3545; }
        .status-pending { border-left: 4px solid #6c757d; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="smartBack()">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="d-inline"><i class="bi bi-list-task"></i> 扫描任务监控</h2>
            </div>
            <div>
                <a href="/api/quick-scan/" class="btn btn-primary">
                    <i class="bi bi-plus"></i> 新建扫描
                </a>
                <button class="btn btn-outline-secondary" onclick="refreshTasks()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
        </div>
        
        <div id="taskList">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function loadTasks() {
            fetch('/api/v1/scans/?ordering=-created_at&limit=20')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('taskList');
                    
                    if (data.results && data.results.length > 0) {
                        container.innerHTML = data.results.map(task => `
                            <div class="card task-card status-${task.status}">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h5 class="card-title mb-1">
                                                ${task.project_name} 
                                                <span class="badge bg-${getStatusColor(task.status)}">${getStatusText(task.status)}</span>
                                            </h5>
                                            <p class="text-muted mb-1">
                                                <i class="bi bi-building"></i> ${task.department_name} | 
                                                <i class="bi bi-tools"></i> ${task.tool_name}
                                            </p>
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> ${new Date(task.created_at).toLocaleString()}
                                            </small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            ${task.total_findings > 0 ? `
                                                <div class="fw-bold">${task.total_findings} 个漏洞</div>
                                                <small class="text-muted">
                                                    C:${task.critical_count} H:${task.high_count} 
                                                    M:${task.medium_count} L:${task.low_count}
                                                </small>
                                            ` : '<span class="text-muted">-</span>'}
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <button class="btn btn-sm btn-outline-primary me-2" 
                                                    onclick="viewLogs(${task.id})">
                                                <i class="bi bi-file-text"></i> 查看日志
                                            </button>
                                            ${task.status === 'running' ? `
                                                <button class="btn btn-sm btn-outline-danger me-2" 
                                                        onclick="killTask(${task.id})">
                                                    <i class="bi bi-stop-circle"></i> 终止任务
                                                </button>
                                            ` : ''}
                                            ${task.status === 'completed' ? `
                                                <a href="/admin/core/project/${task.project}/change/" 
                                                   class="btn btn-sm btn-success" target="_blank">
                                                    <i class="bi bi-eye"></i> 查看结果
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="text-center text-muted">暂无扫描任务</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('taskList').innerHTML = 
                        '<div class="alert alert-danger">加载失败: ' + error + '</div>';
                });
        }
        
        function getStatusColor(status) {
            const colors = {
                'pending': 'secondary',
                'running': 'primary',
                'completed': 'success',
                'failed': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function getStatusText(status) {
            const texts = {
                'pending': '待处理',
                'running': '运行中',
                'completed': '已完成',
                'failed': '失败'
            };
            return texts[status] || status;
        }
        
        function viewLogs(taskId) {
            window.open(`/api/scan-logs/?task_id=${taskId}`, '_blank');
        }
        
        function killTask(taskId) {
            if (!confirm('确定要终止这个扫描任务吗？')) return;
            
            fetch(`/api/v1/scans/${taskId}/kill_task/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    loadTasks();
                } else {
                    alert('终止失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                alert('请求失败: ' + error);
            });
        }
        
        function refreshTasks() {
            loadTasks();
        }
        
        // 初始加载
        loadTasks();
        
        // 自动刷新运行中的任务
        setInterval(() => {
            const runningTasks = document.querySelectorAll('.status-running');
            if (runningTasks.length > 0) {
                loadTasks();
            }
        }, 10000);
    </script>
</body>
</html>