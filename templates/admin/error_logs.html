<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平台错误日志</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="/static/js/navigation.js"></script>
    <style>
        .log-container { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            font-family: 'Courier New', monospace; 
            height: 600px; 
            overflow-y: auto; 
            padding: 15px; 
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .log-error { color: #f44747; }
        .log-warning { color: #ffcc02; }
        .log-info { color: #4ec9b0; }
        .log-debug { color: #569cd6; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="smartBack()">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="d-inline"><i class="bi bi-bug"></i> 平台错误日志</h2>
            </div>
            <div>
                <select class="form-select me-2" id="logLevel" style="width: auto; display: inline-block;">
                    <option value="all">所有级别</option>
                    <option value="ERROR">错误</option>
                    <option value="WARNING">警告</option>
                    <option value="INFO">信息</option>
                    <option value="DEBUG">调试</option>
                </select>
                <select class="form-select me-2" id="logLines" style="width: auto; display: inline-block;">
                    <option value="100">最近100行</option>
                    <option value="500">最近500行</option>
                    <option value="1000">最近1000行</option>
                    <option value="5000">最近5000行</option>
                </select>
                <button class="btn btn-primary" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <button class="btn btn-outline-danger" onclick="clearLogs()">
                    <i class="bi bi-trash"></i> 清空
                </button>
            </div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="text-muted">正在加载日志...</div>
        </div>
    </div>

    <script>
        function refreshLogs() {
            const level = document.getElementById('logLevel').value;
            const lines = document.getElementById('logLines').value;
            
            fetch(`/api/system-logs/?level=${level}&lines=${lines}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('logContainer');
                    if (data.logs) {
                        container.innerHTML = formatLogs(data.logs);
                        container.scrollTop = container.scrollHeight;
                    } else {
                        container.innerHTML = '<div class="text-muted">暂无日志</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('logContainer').innerHTML = 
                        '<div class="text-danger">加载失败: ' + error + '</div>';
                });
        }
        
        function formatLogs(logs) {
            return logs.split('\n').map(line => {
                let className = '';
                if (line.includes('ERROR')) className = 'log-error';
                else if (line.includes('WARNING')) className = 'log-warning';
                else if (line.includes('INFO')) className = 'log-info';
                else if (line.includes('DEBUG')) className = 'log-debug';
                
                return `<div class="${className}">${escapeHtml(line)}</div>`;
            }).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function clearLogs() {
            if (confirm('确定要清空日志吗？此操作不可恢复！')) {
                fetch('/api/system-logs/', {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('logContainer').innerHTML = 
                            '<div class="text-muted">日志已清空</div>';
                    } else {
                        alert('清空失败: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('清空失败: ' + error);
                });
            }
        }
        
        // 自动刷新
        setInterval(refreshLogs, 10000);
        
        // 初始加载
        refreshLogs();
    </script>
</body>
</html>